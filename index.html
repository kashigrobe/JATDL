<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ToDo List</title>

    <!-- Materialize CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">

    <!-- Materialize JavaScript -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
</head>

<body class="container">

    <header>
        <h3 class="center-align">ToDo List </h3>
        <div class="center-align">
            <a id="newTaskBtn" class="waves-effect waves-light btn">New Task</a>
        </div>
    </header>


    <table id="newTask" hidden="hidden">
        <!-- removed "class" object=highlightcentered responsive-table "hidden"hideen">==$0 because of the Materialized CCS feature that prevents my NewTask button to be the hidden -->
        <thead>
            <tr>
                <th>Title</th>
                <th>Description</th>
                <th>Due Date</th>
                <th></th>
            </tr>
        </thead>
        <tbody>
            <!-- The tasks will be rendered here.Task rows will be dynamically inserted here -->
            <tr>
                <td><input type="text" id="newTaskTitle" /></td>
                <td><input type="text" id="newTaskDescription" /></td>
                <td><input type="text" id="newTaskDueDate" /></td>
                <td><a id="newTaskSubmitBtn" class="waves-effect waves-light btn">Submit</a></td>

            </tr>
        </tbody>
    </table>



    <table id="taskTable" class="highlight centered responsive-table">
        <thead>
            <tr>
                <th>ID</th>
                <th>Email</th>
                <th>Title</th>
                <th>Description</th>
                <th>Due Date</th>
                <th>Completed</th>
            </tr>
        </thead>
        <tbody>
            <!-- The tasks will be rendered here.Task rows will be dynamically inserted here -->
        </tbody>
    </table>
    <footer><a href="/register.html">Register</a> with us to get notified via mail on due dates.</footer>

    <script>
        // Wait for the DOM to be fully loaded
        document.addEventListener('DOMContentLoaded', () => {
            // Function to populate the table

            function populateTable(tasks) {
                const tableBody = document.getElementById('taskTable').querySelector('tbody');
                tableBody.innerHTML = ''; // Clear existing rows in table body

                tasks.forEach(task => {
                    const row = tableBody.insertRow();
                    row.insertCell(0).textContent = task.id;
                    row.insertCell(1).textContent = task.email;
                    row.insertCell(2).textContent = task.title;
                    row.insertCell(3).textContent = task.description;
                    row.insertCell(4).textContent = task.due_date;
                    row.insertCell(5).textContent = task.completed ? 'Yes' : 'No';
                });
            }

            // Fetch tasks when the page loads
            fetch('/api/getTasks')
                .then(response => response.json())
                .then(populateTable)
                .catch(console.error);

            function showNewTaskSection() {
                console.log("show me everything")

                const newTaskTable = document.getElementById("newTask");
                newTaskTable.removeAttribute("hidden");             
            }

           async function sendNewTaskToServer(){
                console.log("Are you saved")
            // After submit is clicked => Tasks gets sent to DB
            // Read input values from form fields and create an object
            const newTaskTitle = document.getElementById('newTaskTitle').value;
                const newTaskDescription = document.getElementById('newTaskDescription').value;
                const newTaskDueDate = document.getElementById('newTaskDueDate').value;

            // Create a JavaScript object to hold the task data
                const newTask = {
                    title: newTaskTitle,
                    description: newTaskDescription,
                    due_date: newTaskDueDate
                };
           // Send the created object to the server
           try {
                    const response = await fetch('/api/addTask', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(newTask)
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        console.log(data.message);
                    } else {
                        const data = await response.json();
                        console.log('Error:', data.error);
                    }
                } catch (err) {
                    console.error('Network or server error:', err);
                }
                
                // Clear the input fields for new data entry
                document.getElementById('newTaskTitle').value = '';
                document.getElementById('newTaskDescription').value = '';
                document.getElementById('newTaskDueDate').value = '';
            }

            // Initialize the page
            function initializePage() {
                const newTaskButton = document.getElementById('newTaskBtn');
                newTaskButton.addEventListener("click", showNewTaskSection);

                const newTaskSubmitButton = document.getElementById('newTaskSubmitBtn');
                newTaskSubmitButton.addEventListener("click", sendNewTaskToServer);
            }

            initializePage();
        });
    </script>
</body>

</html>